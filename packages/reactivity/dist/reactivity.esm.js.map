{
  "version": 3,
  "sources": ["../src/effect.ts", "../../shared/src/index.ts", "../src/reactiveEffect.ts", "../src/baseHandler.ts", "../src/reactive.ts", "../src/ref.ts"],
  "sourcesContent": ["export let activeEffect = null\n\nfunction cleanDepEffect(dep, effect) {\n  dep.delete(effect)\n  if (dep.size === 0) {\n    dep.cleanup()\n  }\n}\n\nfunction preCleanEffect(effect) {\n  effect._depLength = 0\n  effect._trackId++\n}\n\nfunction postCleanEffect(effect) {\n  if (effect.deps.length > effect._depLength) {\n    for (let i = effect._depLength; i < effect.deps.length; i++) {\n      cleanDepEffect(effect.deps[i], effect)\n    }\n    effect.deps.length = effect._depLength\n  }\n}\n\nclass ReactiveEffect {\n  public _trackId = 0\n\n  public deps = []\n\n  public _depLength = 0\n\n  public active = true\n\n  public running = 0\n\n  constructor(public fn, public scheduler) {\n\n  }\n  run() {\n    if (!this.active) {\n      return this.fn()\n    }\n\n    let lastEffect = activeEffect\n\n    try {\n      activeEffect = this\n      preCleanEffect(this)\n      this.running++\n      // \u4F9D\u8D56\u6536\u96C6\n      return this.fn()\n    } finally {\n      this.running--\n      postCleanEffect(this)\n      activeEffect = lastEffect\n    }\n  }\n}\n\n// effect\uFF1A\u5BF9\u54CD\u5E94\u5F0F\u6570\u636E\u6536\u96C6\u4F9D\u8D56\n// 1. \u5904\u7406\u51FD\u6570\u4F1A\u7ACB\u5373\u6267\u884C\uFF0C\u5982\u679C\u662F\u54CD\u5E94\u5F0F\u6570\u636E\uFF0C\u5219\u8FDB\u884C\u6536\u96C6\u4F9D\u8D56\n// 2. \u5F53\u54CD\u5E94\u5F0F\u6570\u636E\u53D1\u751F\u53D8\u5316\uFF0C\u4F1A\u89E6\u53D1trigger\uFF0C\u6267\u884Ceffect\u7684scheduler\uFF0C\u5373effect.run()\n// 3. \u5982\u4F55\u5B9E\u73B0\u6536\u96C6\u4F9D\u8D56\nexport function effect(fn, options) {\n  const _effect = new ReactiveEffect(fn, () => {\n    _effect.run()\n  })\n  _effect.run()\n\n  if (options) {\n    Object.assign(_effect, options)\n  }\n\n  return _effect\n}\n\nexport function trackEffects(effect, dep) {\n  if (dep.get(effect) !== effect._trackId) {\n    dep.set(effect, effect._trackId)\n  }\n\n  let oldDep = effect.deps[effect._depLength]\n  if (oldDep !== dep) {\n    if (oldDep) {\n      cleanDepEffect(oldDep, effect)\n    }\n    effect.deps[effect._depLength++] = dep\n  } else {\n    effect._depLength++\n  }\n}\n\nexport function triggerEffects(dep) {\n  for (const effect of dep.keys()) {\n    if (effect.running === 0 && effect.scheduler) {\n      effect.scheduler()\n    }\n  }\n}\n", "export function isObject(val: unknown): val is Record<any, any> {\n  return val !== null && typeof val === 'object'\n}\n", "import { activeEffect, trackEffects, triggerEffects } from \"./effect\"\n\nconst targetMap = new WeakMap()\n\nexport function createDep(cleanup, key) {\n  const dep = new Map() as any\n  dep.cleanup = cleanup\n  dep.name = key\n  return dep\n}\n\n// targetMap example:\n// WeakMap {Object => Map(2)}\n// { \n//  key: { name: 'lihua', age: 18 }\n//  value: Map(2) {\n//   key: 'name',\n//   value: Map(1) {\n//     key: effect\n//     value: effect._trackId\n//   }\n//  }\n// }\n\nexport function track(target, key) {\n  if (!activeEffect) return\n\n  let depsMap = targetMap.get(target)\n  if (!depsMap) {\n    targetMap.set(target, depsMap = new Map())\n  }\n\n  let dep = depsMap.get(key)\n  if (!dep) {\n    depsMap.set(key, dep = createDep(() => depsMap.delete(key), key))\n  }\n\n  trackEffects(activeEffect, dep)\n}\n\nexport function trigger(target, key) {\n  const depsMap = targetMap.get(target)\n  if (!depsMap) return\n\n  let dep = depsMap.get(key)\n  if (!dep) return\n\n  triggerEffects(dep)\n}\n", "import { isObject } from \"@chibivue/shared\"\nimport { track, trigger } from \"./reactiveEffect\"\nimport { reactive } from \"./reactive\"\n\nexport enum ReactiveFlags {\n  IS_REACTIVE = '__v_isReactive'\n}\n\nexport const mutableHandlers: ProxyHandler<any> = {\n  get(target, key, receiver) {\n    if (key === ReactiveFlags.IS_REACTIVE) {\n      return true\n    }\n\n    track(target, key)\n\n    const result = Reflect.get(target, key, receiver)\n    if (isObject(result)) {\n      return reactive(result)\n    }\n    return result\n  },\n  set(target, key, value, receiver) {\n    const oldValue = target[key]\n\n    const result = Reflect.set(target, key, value, receiver)\n\n    if (oldValue !== value) {\n      trigger(target, key)\n    }\n\n    return result\n  }\n}\n", "import { isObject } from \"@chibivue/shared\"\nimport { ReactiveFlags, mutableHandlers } from './baseHandler'\n\nconst reactiveMap = new WeakMap()\n\nfunction createReactiveObject(target) {\n  if (!isObject(target)) {\n    return target\n  }\n\n  if (target[ReactiveFlags.IS_REACTIVE]) {\n    return target\n  }\n\n  const existingProxy = reactiveMap.get(target)\n  if (existingProxy) {\n    return existingProxy\n  }\n\n  const proxy = new Proxy(target, mutableHandlers)\n  reactiveMap.set(target, proxy)\n  \n  return proxy\n}\n\nexport function reactive(target) {\n  return createReactiveObject(target)\n}\n\nexport function toReactive(value) {\n  return isObject(value) ? reactive(value) : value\n}\n", "import { toReactive } from \"./reactive\"\nimport { activeEffect, trackEffects, triggerEffects } from \"./effect\"\nimport { createDep } from \"./reactiveEffect\"\n\nfunction trackRefValue(ref) {\n  if (activeEffect) {\n    trackEffects(activeEffect, ref.dep || (ref.dep = createDep(() => ref.dep = null, 'value')))\n  }\n}\n\nfunction triggerRefValue(ref) {\n  if (ref.dep) {\n    triggerEffects(ref.dep)\n  }\n}\n\nclass RefImpl {\n  public __v_isRef = true\n\n  public _value\n\n  public dep\n\n  constructor(public rawValue) {\n    this._value = toReactive(rawValue)\n  }\n\n  get value() {\n    trackRefValue(this)\n    return this._value\n  }\n  set value(newValue) {\n    if (newValue !== this.rawValue) {\n      this._value = newValue\n      this.rawValue = newValue\n      triggerRefValue(this)\n    }\n  }\n}\n\nfunction createRef(value) {\n  const ref = new RefImpl(value)\n  return ref\n}\n\nexport function ref(value) {\n  return createRef(value)\n}\n"],
  "mappings": "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",
  "names": ["effect", "ref"]
}
